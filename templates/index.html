<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TensorArt Turbo Studio</title>
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
    <div class="aurora"></div>
    <main class="shell">
        <section class="panel hero">
            <div>
                <p class="eyebrow">TensorArt · SD 3.5 Turbo</p>
                <h1>Generate bold visuals in seconds</h1>
                <p class="lede">Streamlined FastAPI controls plus a focused UI so you can explore prompts, iterate quickly, and collect production-ready renders without leaving the browser.</p>
                <ul class="stats">
                    <li>
                        <span class="value">{{ form.width }}×{{ form.height }}</span>
                        <span class="label">Current Canvas</span>
                    </li>
                    <li>
                        <span class="value">{{ form.num_inference_steps }}</span>
                        <span class="label">Steps</span>
                    </li>
                    <li>
                        <span class="value">{{ form.guidance_scale }}</span>
                        <span class="label">Guidance</span>
                    </li>
                </ul>
            </div>
        </section>

        <section class="panel generator">
            <form method="post" class="form-grid" data-generator-form>
                <label>
                    <span>Prompt</span>
                    <textarea name="prompt" rows="3" required>{{ form.prompt }}</textarea>
                </label>
                <label>
                    <span>Negative Prompt</span>
                    <textarea name="negative_prompt" rows="2">{{ form.negative_prompt or '' }}</textarea>
                </label>
                <div class="inline-fields">
                    <label>
                        <span>Width</span>
                        <input type="number" name="width" min="256" max="1536" step="8" value="{{ form.width }}" required />
                    </label>
                    <label>
                        <span>Height</span>
                        <input type="number" name="height" min="256" max="1536" step="8" value="{{ form.height }}" required />
                    </label>
                </div>
                <div class="inline-fields">
                    <label>
                        <span>Guidance</span>
                        <input type="number" name="guidance_scale" step="0.1" min="0" max="20" value="{{ form.guidance_scale }}" required />
                    </label>
                    <label>
                        <span>Steps</span>
                        <input type="number" name="num_inference_steps" min="1" max="80" value="{{ form.num_inference_steps }}" required />
                    </label>
                    <label>
                        <span>Seed</span>
                        <input type="text" name="seed" inputmode="numeric" pattern="[0-9]*" value="{{ form.seed }}" placeholder="auto" />
                    </label>
                </div>
                <button type="submit">Render with TensorArt</button>
                <div class="toast error" id="client-error" {% if not error %}hidden{% endif %}>{{ error or '' }}</div>
                <div class="loading-indicator" id="render-loading" hidden>
                    <div class="spinner" aria-hidden="true"></div>
                    <div>
                        <p>Spinning up the pipeline…</p>
                        <p class="hint">First loads may take a minute while weights download.</p>
                    </div>
                </div>
            </form>
        </section>

        <section class="panel preview">
            <div id="result-frame" data-has-result="{{ 'true' if result else 'false' }}">
                {% if result %}
                <div class="image-frame">
                    <img src="data:image/png;base64,{{ result.image_base64 }}" alt="Generated artwork" />
                    <div class="meta">Ready in {{ result.elapsed_ms }} ms</div>
                </div>
                {% else %}
                <div class="placeholder">
                    <p>Output will land here. Dream up something vibrant and hit “Render”.</p>
                </div>
                {% endif %}
            </div>
        </section>

        <section class="panel console">
            <div class="console-head">
                <div>
                    <p class="eyebrow">Live Console</p>
                    <h2>Server Log Stream</h2>
                </div>
                <div class="console-actions">
                    <button type="button" class="ghost" id="copy-logs">Copy logs</button>
                    <button type="button" class="ghost" id="toggle-scroll">Auto-scroll: On</button>
                </div>
            </div>
            <pre id="log-output" aria-live="polite">Loading log buffer…</pre>
        </section>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("[data-generator-form]");
            if (!form || !window.fetch) {
                return;
            }

            const button = form.querySelector('button[type="submit"]');
            const defaultButtonLabel = button.textContent;
            const loader = document.getElementById("render-loading");
            const toast = document.getElementById("client-error");
            const resultFrame = document.getElementById("result-frame");
            const logOutput = document.getElementById("log-output");
            const toggleScroll = document.getElementById("toggle-scroll");
            const copyLogsBtn = document.getElementById("copy-logs");
            let autoScroll = true;

            if (toggleScroll) {
                toggleScroll.addEventListener("click", () => {
                    autoScroll = !autoScroll;
                    toggleScroll.textContent = `Auto-scroll: ${autoScroll ? "On" : "Off"}`;
                });
            }

            if (copyLogsBtn && logOutput && navigator.clipboard) {
                copyLogsBtn.addEventListener("click", async () => {
                    const text = logOutput.textContent?.trim() ?? "";
                    const hasLogs = text && !/(Awaiting log output…|Loading log buffer…)/.test(text);
                    if (!hasLogs) {
                        setToast("No logs to copy yet");
                        window.setTimeout(() => setToast(null), 2000);
                        return;
                    }
                    const originalLabel = copyLogsBtn.textContent;
                    try {
                        await navigator.clipboard.writeText(text);
                        copyLogsBtn.textContent = "Copied";
                    } catch (err) {
                        setToast("Clipboard copy failed");
                        window.setTimeout(() => setToast(null), 2000);
                    } finally {
                        window.setTimeout(() => {
                            copyLogsBtn.textContent = originalLabel;
                        }, 1500);
                    }
                });
            }

            function showLoader(show) {
                if (show) {
                    loader?.removeAttribute("hidden");
                    button.disabled = true;
                    button.textContent = "Rendering…";
                } else {
                    loader?.setAttribute("hidden", "hidden");
                    button.disabled = false;
                    button.textContent = defaultButtonLabel;
                }
            }

            function setToast(message) {
                if (!toast) return;
                if (!message) {
                    toast.setAttribute("hidden", "hidden");
                    toast.textContent = "";
                    return;
                }
                toast.removeAttribute("hidden");
                toast.textContent = message;
            }

            function updatePreview(data) {
                if (!resultFrame) return;
                resultFrame.dataset.hasResult = "true";
                resultFrame.innerHTML = `
                    <div class="image-frame">
                        <img src="data:image/png;base64,${data.image_base64}" alt="Generated artwork" />
                        <div class="meta">Ready in ${data.elapsed_ms} ms</div>
                    </div>
                `;
            }

            form.addEventListener("submit", async (event) => {
                event.preventDefault();
                const formData = new FormData(form);
                const payload = {
                    prompt: formData.get("prompt") ?? "",
                    negative_prompt: formData.get("negative_prompt") || null,
                    width: Number(formData.get("width")),
                    height: Number(formData.get("height")),
                    guidance_scale: Number(formData.get("guidance_scale")),
                    num_inference_steps: Number(formData.get("num_inference_steps")),
                    seed: formData.get("seed") ? Number(formData.get("seed")) : null,
                };

                setToast(null);
                showLoader(true);

                try {
                    const response = await fetch("/api/generate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({}));
                        throw new Error(errorBody.detail || "Generation failed");
                    }

                    const data = await response.json();
                    updatePreview(data);
                } catch (err) {
                    const message = err instanceof Error ? err.message : "Something went wrong";
                    setToast(message);
                } finally {
                    showLoader(false);
                }
            });

            async function pollLogs() {
                try {
                    const response = await fetch(`/api/logs?limit=200&_=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        const lines = Array.isArray(data.lines) ? data.lines : [];
                        if (logOutput) {
                            const shouldStick =
                                autoScroll &&
                                Math.abs(logOutput.scrollHeight - logOutput.clientHeight - logOutput.scrollTop) < 20;
                            logOutput.textContent = lines.length ? lines.join("\n") : "Awaiting log output…";
                            if (shouldStick) {
                                logOutput.scrollTop = logOutput.scrollHeight;
                            }
                        }
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    window.setTimeout(pollLogs, 5000);
                }
            }

            pollLogs();
        });
    </script>
</body>
</html>
